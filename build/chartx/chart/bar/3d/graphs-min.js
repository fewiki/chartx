define("chartx/chart/bar/3d/graphs",["canvax/index","canvax/shape/Rect","chartx/utils/tools","chartx/chart/theme","canvax/animation/AnimationFrame","canvax/shape/BrokenLine","canvax/shape/Shapes","chartx/utils/math3d/gl-matrix","chartx/utils/colorformat","canvax/animation/AnimationFrame"],function(a,b,c,d,e,f,g,i,j,e){var k=i.vec3,l=(i.vec4,i.mat4,function(a){var b=a.graphs;this.root=a,this.data=[],this.w=0,this.h=0,this.depth=50,this._yAxisFieldsMap={},this._setyAxisFieldsMap(),this.animation=!0,this.pos={x:0,y:0},this._colors=d.colors,this.bar={width:0,_width:0,radius:4},this.text={enabled:!1,fillStyle:"#999",fontSize:12,format:null,lineWidth:1,strokeStyle:"white"},this.average={enabled:!1,field:"average",fieldInd:-1,fillStyle:"#c4c9d6",data:null},this.checked={enabled:!1,fillStyle:"#00A8E6",strokeStyle:"#00A8E6",globalAlpha:.1,lineWidth:2},this.sort=null,this._barsLen=0,this.eventEnabled=!0,this.sprite=null,this.txtsSp=null,this.checkedSp=null,this.yDataSectionLen=0,_.deepExtend(this,b),this._initaverage(),this.init()});return l.prototype={init:function(){this.sprite=new a.Display.Sprite({id:"graphsEl"}),this.barsSp=new a.Display.Sprite({id:"barsSp"}),this.txtsSp=new a.Display.Sprite({id:"txtsSp",context:{}}),this.checkedSp=new a.Display.Sprite({id:"checkedSp"})},setX:function(a){this.sprite.context.x=a},setY:function(a){this.sprite.context.y=a},getInfo:function(a){return this._getInfoHandler({iGroup:a})},_checked:function(a){var c=this,d=a.iNode,e=c.barsSp.getChildById("barGroup_"+d);if(e){c.checkedSp.removeChildById("line_"+d),c.checkedSp.removeChildById("rect_"+d);var g=e.getChildAt(0),h=g.context.x,i=g.context.x+g.context.width,j=-c.h;if(a.checked){var k=new b({id:"rect_"+d,pointChkPriority:!1,context:{x:h,y:j,width:g.context.width,height:g.context.height,fillStyle:c.checked.fillStyle,globalAlpha:c.checked.globalAlpha}});c.checkedSp.addChild(k);var l=new f({id:"line_"+d,context:{pointList:[[h,j],[i,j]],strokeStyle:c.checked.strokeStyle,lineWidth:c.checked.lineWidth}});c.checkedSp.addChild(l)}}},removeAllChecked:function(){var a=this;a.checkedSp.removeAllChildren()},setBarStyle:function(a){for(var b=this,c=a.iNode,d=b.barsSp.getChildById("barGroup_"+c),e=a.fillStyle||b._getColor(b.bar.fillStyle),f=0,g=d.getNumChildren();f<g;f++){var h=d.getChildAt(f);h.context.fillStyle=e}},_setyAxisFieldsMap:function(){var a=this;_.each(_.flatten(this.root.dataFrame.yAxis.field),function(b,c){a._yAxisFieldsMap[b]={index:c}})},_initaverage:function(){this.average.enabled&&_.each(this.root.dataFraem,function(a,b){a.field==this.average.field&&(this.average.fieldInd=b)})},_getColor:function(a,b,c,d,e,f,g,h){var i=null;return _.isString(a)&&(i=a),_.isArray(a)&&(i=_.flatten(a)[this._yAxisFieldsMap[h].index]),_.isFunction(a)&&(i=a.apply(this,[{iGroup:d,iNode:e,iLay:f,field:h,value:g,xAxis:{field:this.root._xAxis.field,value:this.root._xAxis.data[e].content}}])),i&&""!=i||(i=this._colors[this._yAxisFieldsMap[h].index]),i},_getFieldFromIHV:function(a,b,c){var d=this.root._yAxis.field,e=null;return _.isString(d[a])?e=d[a]:_.isArray(d[a])&&(e=d[a][c]),e},checkBarW:function(a,b){this.bar.width?_.isFunction(this.bar.width)?this.bar._width=this.bar.width(a):this.bar._width=this.bar.width:(this.bar._width=parseInt(b)-parseInt(Math.max(1,.3*b)),1==this.bar._width&&a>3&&(this.bar._width=parseInt(a)-2)),this.bar._width<1&&(this.bar._width=1)},resetData:function(a,b){this.draw(a.data,b)},draw:function(d,e){if(_.deepExtend(this,e),0!=d.length){var f=0;this.data[0]&&(f=this.data[0][0].length),this.data=d;var i=this,j=d.length,k=0;_.each(d,function(b,d){var e=b.length;if(0!=e){var l=b[0].length;for(k=i.w/l,i._barsLen=l*j,h=0;h<l;h++){var m;if(0==d){if(h<=f-1?m=i.barsSp.getChildById("barGroup_"+h):(m=i.barsSp.getChildById("barGroup_"+h)||new a.Display.Sprite({id:"barGroup_"+h}),i.barsSp.addChild(m),m.iNode=h,m.on("click dblclick mousedown mousemove mouseup",function(a){a.eventInfo||(a.eventInfo=i._getInfoHandler(this))})),i.eventEnabled){var n,o=k*h,p=o+k,q=i.sort&&"desc"==i.sort?0:-i.h,r=q+i.h,s=i.root._back._depth,t=[[o,q,s],[p,q,s],[p,r,s],[p,r,0],[o,r,0],[o,r,s]];n=m.getChildById("bhr_polygon_"+h)||new g.Polygon({id:"bhr_polygon_"+h,pointChkPriority:!1,context:{x:0,y:0,pointList:t,fillStyle:"#ccc",globalAlpha:0}}),n.context.pointList=t,m.addChild(n),n.hover(function(a){this.context.globalAlpha=.5},function(a){this.context.globalAlpha=0}),n.iGroup=-1,n.iNode=h,n.iLay=-1,n.on("panstart mouseover mousemove mouseout click",function(a){a.eventInfo=i._getInfoHandler(this,a)})}}else m=i.barsSp.getChildById("barGroup_"+h);var u;for(0==d?h<=f-1?u=i.txtsSp.getChildById("txtGroup_"+h):(u=i.txtsSp.getChildById("txtGroup_"+h)||new a.Display.Sprite({id:"txtGroup_"+h}),i.txtsSp.addChild(u),u.iGroup=d):u=i.txtsSp.getChildById("txtGroup_"+h),v=0;v<e;v++){var w=b[v][h];w.iGroup=d,w.iNode=h,w.iLay=v;var x=parseInt(Math.abs(w.y));v>0&&(x-=parseInt(Math.abs(b[v-1][h].y)));var y=parseInt(w.y),z=i._getColor(i.bar.fillStyle,j,e,d,h,v,w.value,w.field);if(0==h){var A=i._yAxisFieldsMap[i._getFieldFromIHV(d,h,v)];A.fillStyle||(A.fillStyle=z)}w.fillStyle=z;var B={x:Math.round(w.x-i.bar._width/2),y:y,width:parseInt(i.bar._width),height:x,fillStyle:z,scaleY:1},C={x:B.x,y:0,width:B.width,height:0,fillStyle:B.fillStyle,scaleY:0};if(i.bar.radius&&v==e-1){var D=Math.min(i.bar._width/2,x);D=Math.min(D,i.bar.radius),C.radius=[D,D,0,0]}i.animation||(delete C.scaleY,C.y=B.y,C.height=B.height);var E=m.getChildById("bar_"+d+"_"+h+"_"+v)||new a.Display.Sprite({id:"bar_"+d+"_"+h+"_"+v});if(i.drawCube(E,C),m.addChild(E),E.finalPos=B,E.iGroup=d,E.iNode=h,E.iLay=v,i.eventEnabled&&E.on("panstart mouseover mousemove mouseout click dblclick",function(a){a.eventInfo=i._getInfoHandler(this,a),"mouseover"==a.type&&(this.parent.getChildById("bhr_"+this.iNode).context.globalAlpha=.1),"mouseout"==a.type&&(this.parent.getChildById("bhr_"+this.iNode).context.globalAlpha=0)}),v==e-1&&i.text.enabled){var F,G=[w];if(h<=f-1?F=u.getChildById("infosp_"+d+"_"+h):(F=u.getChildById("infosp_"+d+"_"+h)||new a.Display.Sprite({id:"infosp_"+d+"_"+h,context:{visible:!1}}),F._hGroup=h,u.addChild(F)),F.noSkip=!0,e>1)for(var H=e-2;H>=0;H--)G.unshift(b[H][h]);var I=0,J=0;_.each(G,function(b,g){var j=b.value;!i.animation&&_.isFunction(i.text.format)&&(j=i.text.format(b.value)),!i.animation&&_.isNumber(j)&&(j=c.numAddSymbol(j));var k;h<=f-1?k=F.getChildById("info_txt_"+d+"_"+h+"_"+g):(k=new a.Display.Text(j,{id:"info_txt_"+d+"_"+h+"_"+g,context:{x:I+2,fillStyle:b.fillStyle,fontSize:i.text.fontSize,lineWidth:i.text.lineWidth,strokeStyle:i.text.strokeStyle}}),k.z=.5*-i.depth,F.addChild(k)),k._text=j,I+=k.getTextWidth()+2,J=Math.max(J,k.getTextHeight()),i.animation&&k.resetText(0),g<=e-2&&(k=new a.Display.Text("/",{context:{x:I+2,fillStyle:"#999"}}),k.z=.5*-i.depth,I+=k.getTextWidth()+2,F.addChild(k))}),F._finalX=w.x-I/2,F._finalY=B.y-J,F._centerX=w.x,F.context.width=I,F.context.height=J,F.context.x=w.x-I/2,i.animation||(F.context.y=B.y-J-15,F.context.visible=!0)}}}}}),this.sprite.addChild(this.barsSp),this.sprite.addChild(this.checkedSp),this.text.enabled&&this.sprite.addChild(this.txtsSp),this.average.enabled&&this.average.data&&(!this.averageSp&&(this.averageSp=new a.Display.Sprite({id:"averageSp"})),_.each(this.average.layoutData,function(a,c){var d,e={x:k*c,y:a.y,fillStyle:i.average.fillStyle,width:k,height:2};c<=f-1?(d=i.averageSp.getChildById("average_"+c),d.context.x=e.x,d.context.y=e.y,d.context.width=e.width):(d=new b({id:"average_"+c,context:e}),i.averageSp.addChild(d))}),this.sprite.addChild(i.averageSp)),this.sprite.context.x=this.pos.x,this.sprite.context.y=this.pos.y,this.sort&&"desc"==this.sort&&(this.sprite.context.y-=this.h)}},_updateInfoTextPos:function(a,b){if("horizontal"!=this.root.type){var c=0,d=0,e=a.children.length;_.each(a.children,function(a,b){a.getTextWidth&&(a.context.x=c,c+=a.getTextWidth()+(b<e?2:0),d=Math.max(d,a.getTextHeight()))}),a.context.width=c,a.context.height=d,0===b&&this.root._to3d(a)}},grow:function(a,b){var d=this;if(!this.animation)return void(a&&a(d));var f=1;if(this.sort&&"desc"==this.sort&&(f=-1),d.data[0]&&d.barsSp.children.length>d.data[0][0].length)for(var g=d.data[0][0].length,i=d.barsSp.children.length;g<i;g++)d.barsSp.getChildAt(g).destroy(),d.text.enabled&&d.txtsSp.getChildAt(g).destroy(),d.averageSp&&d.averageSp.getChildAt(g).destroy(),g--,i--;var j=_.extend({delay:Math.min(1e3/this._barsLen,200),easing:"Back.Out",duration:500},b);_.each(d.data,function(a,b){var g=a.length;if(0!=g){var i=a[0].length;for(h=0;h<i;h++){for(v=0;v<g;v++){var k=d.barsSp.getChildById("barGroup_"+h),l=k.getChildById("bar_"+b+"_"+h+"_"+v);if(0==j.duration)l.context.scaleY=f,l.context.y=f*f*l.finalPos.y,l.context.x=l.finalPos.x,l.context.width=l.finalPos.width,l.context.height=l.finalPos.height;else{l._tweenObj&&e.destroyTween(l._tweenObj);var m={from:{y:0,height:0},to:{y:l.finalPos.y,height:l.finalPos.height},onUpdate:function(a,b){var c=a;return function(a){b.drawCube(c,{x:c.finalPos.x,y:this.y,width:c.finalPos.width,height:this.height}),b.root._to3d(c)}}(l,d),onComplete:function(){},id:l.id,duration:j.duration,easing:j.easing,delay:h*j.delay};l._tweenObj=e.registTween(m)}}if(d.text.enabled){var n=d.txtsSp.getChildById("txtGroup_"+h),o=n.getChildById("infosp_"+b+"_"+h);"horizontal"==d.root.type&&(o.context.x=o._finalX),o.animate({y:o._finalY-15,x:o._finalX},{duration:j.duration,easing:j.easing,delay:h*j.delay,onUpdate:function(){this.context.visible=!0},onComplete:function(){}}),_.each(o.children,function(a,b){a._text&&(a._tweenObj&&e.destroyTween(a._tweenObj),a._tweenObj=e.registTween({from:{v:a.text},to:{v:a._text},duration:j.duration,delay:h*j.delay,onUpdate:function(a,b){return function(){var e=this.v;_.isFunction(d.text.format)?e=d.text.format(e):_.isNumber(e)&&(e=c.numAddSymbol(parseInt(e))),a.resetText(e),a.parent?d._updateInfoTextPos(a.parent,b):a.destroy()}}(a,b)}))})}}}}),window.setTimeout(function(){a&&a(d)},300*(this.barsSp.children.length-1))},_getInfoHandler:function(a){var b={iGroup:a.iGroup,iNode:a.iNode,iLay:a.iLay,nodesInfoList:this._getNodeInfo(a.iGroup,a.iNode,a.iLay)};return b},_getNodeInfo:function(a,b,c){var d=[],e=this,f=e.data.length;return void 0==a&&(a=-1),void 0==b&&(b=0),void 0==c&&(c=-1),_.each(e.data,function(g,i){var j,k=g.length;if(0!=k){var l=g[0].length;for(h=0;h<l;h++)if(h==b)for(v=0;v<k;v++)a!=i&&a!=-1||c!=v&&c!=-1||(j=g[v][h],j.fillStyle=e._getColor(e.bar.fillStyle,f,k,i,h,v,j.value,j.field),d.push(j))}}),d},drawCube:function(a,b){var c=this,d=b.x,e=d+b.width,f=b.y,g=f+b.height,h=-1*c.depth,i=b.fillStyle,k=b.fillStyle,l=j.colorBrightness(b.fillStyle,.1),m=j.colorBrightness(b.fillStyle,-.1),n=[[d,f,0],[d,f,h],[d,g,h],[d,g,0]],o=c.drawFace("polygon_left",n,m,i,a),n=[[d,f,0],[e,f,0],[e,g,0],[d,g,0]],p=c.drawFace("polygon_front",n,k,i,a),n=[[e,f,0],[e,f,h],[e,g,h],[e,g,0]],q=c.drawFace("polygon_right",n,m,i,a),n=[[d,f,0],[e,f,0],[e,f,h],[d,f,h]],r=c.drawFace("polygon_top",n,l,i,a);a.addChild(o),a.addChild(p),a.addChild(q),a.addChild(r)},drawFace:function(a,b,c,d,e){var f=e.getChildById(a)||new g.Polygon({id:a,pointChkPriority:!1,context:{pointList:b,strokeStyle:d,fillStyle:c}});return f.context.pointList=b,f.context.x=0,f.context.y=0,f},_depthTest:function(a){!function(a){var b=arguments.callee;if(a.children&&a.children.length>0)_.each(a.children,function(a,c){b(a)});else{var c=a.parent;if(a instanceof g.Polygon&&~c.id.indexOf("bar_")){var d=null,e=a.context.pointList;if(_.each(c.children,function(a,b){~a.id.indexOf("front")&&(d=a.context.pointList)}),~a.id.indexOf("left")||~a.id.indexOf("right")){var f=!1,h=k.fromValues(e[1][0],e[1][1],0);if(~a.id.indexOf("left"))var i=k.fromValues(d[0][0],d[0][1],0),j=k.fromValues(d[3][0],d[3][1],0);if(~a.id.indexOf("right"))var i=k.fromValues(d[1][0],d[1][1],0),j=k.fromValues(d[2][0],d[2][1],0);var l=k.create(),m=k.create(),n=k.create();k.sub(l,h,i),k.normalize(l,l),k.sub(m,i,j),k.normalize(m,m),k.cross(n,l,m),~a.id.indexOf("left")&&n[2]<0?f=!0:~a.id.indexOf("right")&&n[2]>0&&(f=!0),f?a.context.visible=!1:a.context.visible=!0}}}}(a)}},l});